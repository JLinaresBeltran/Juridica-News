generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                     String              @id @default(cuid())
  email                  String              @unique
  password               String
  firstName              String              @map("first_name")
  lastName               String              @map("last_name")
  role                   String              @default("EDITOR")
  status                 String              @default("ACTIVE")
  avatar                 String?
  department             String?
  emailVerified          DateTime?           @map("email_verified")
  emailVerificationToken String?             @unique @map("email_verification_token")
  passwordResetToken     String?             @unique @map("password_reset_token")
  passwordResetExpires   DateTime?           @map("password_reset_expires")
  lastLogin              DateTime?           @map("last_login")
  createdAt              DateTime            @default(now()) @map("created_at")
  updatedAt              DateTime            @updatedAt @map("updated_at")
  articlesCreated        Article[]           @relation("ArticleAuthor")
  auditLogs              AuditLog[]
  documentsExtracted     Document[]          @relation("DocumentExtractor")
  documentsCreated       Document[]          @relation("DocumentCreator")
  extractionHistory      ExtractionHistory[]
  refreshTokens          RefreshToken[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Document {
  id                 String    @id @default(cuid())
  title              String
  url                String    @unique
  content            String
  fullTextContent    String?   @map("full_text_content")
  documentPath       String?   @map("document_path")
  summary            String?
  source             String
  legalArea          String    @map("legal_area")
  documentType       String    @map("document_type")
  status             String    @default("PENDING")
  priority           String    @default("NORMAL")
  publicationDate    DateTime  @map("publication_date")
  webOfficialDate    DateTime? @map("web_official_date")
  internalId         String?   @map("internal_id")
  extractionDate     DateTime  @default(now()) @map("extraction_date")
  lastReviewDate     DateTime? @map("last_review_date")
  confidenceScore    Float     @default(0.0) @map("confidence_score")
  keywords           String    @default("")
  relevanceTags      String    @default("") @map("relevance_tags")
  externalId         String?   @unique @map("external_id")
  metadata           String    @default("{}")
  extractedAt        DateTime? @map("extracted_at")
  userId             String?   @map("user_id")
  numeroSentencia    String?   @map("numero_sentencia")
  magistradoPonente  String?   @map("magistrado_ponente")
  salaRevision       String?   @map("sala_revision")
  expediente         String?   @map("expediente")
  temaPrincipal      String?   @map("tema_principal")
  resumenIA          String?   @map("resumen_ia")
  decision           String?   @map("decision")
  aiAnalysisStatus   String?   @default("PENDING") @map("ai_analysis_status")
  aiAnalysisDate     DateTime? @map("ai_analysis_date")
  aiModel            String?   @map("ai_model")
  fragmentosAnalisis String?   @default("") @map("fragmentos_analisis")
  // Campos para artículos y títulos generados
  generatedArticle   String?   @map("generated_article")
  generatedTitles    String?   @map("generated_titles") // JSON array de títulos
  selectedTitle      String?   @map("selected_title")
  articleStyle       String?   @map("article_style") // serious, catchy, educational
  titleStyle         String?   @map("title_style")
  articleModel       String?   @map("article_model") // gpt4o-mini, gemini
  titleModel         String?   @map("title_model")
  articleGeneratedAt DateTime? @map("article_generated_at")
  titlesGeneratedAt  DateTime? @map("titles_generated_at")
  curatorId          String?   @map("curator_id")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  user               User?     @relation("DocumentExtractor", fields: [userId], references: [id])
  curator            User?     @relation("DocumentCreator", fields: [curatorId], references: [id])
  generatedImages    GeneratedImage[]

  @@map("documents")
}

model Article {
  id                 String           @id @default(cuid())
  title              String
  slug               String           @unique
  content            String
  summary            String
  metaTitle          String?          @map("meta_title")
  metaDescription    String?          @map("meta_description")
  keywords           String           @default("")
  canonicalUrl       String?          @map("canonical_url")
  status             String           @default("DRAFT")
  publicationSection String           @map("publication_section")
  tags               String           @default("")
  publishedAt        DateTime?        @map("published_at")
  scheduledAt        DateTime?        @map("scheduled_at")
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")
  views              Int              @default(0)
  likes              Int              @default(0)
  wordCount          Int              @default(0) @map("word_count")
  readingTime        Int              @default(0) @map("reading_time")
  authorId           String           @map("author_id")
  versions           ArticleVersion[]
  author             User             @relation("ArticleAuthor", fields: [authorId], references: [id])
  mediaAssets        MediaAsset[]
  generatedImages    GeneratedImage[]

  @@map("articles")
}

model ArticleVersion {
  id                String   @id @default(cuid())
  articleId         String   @map("article_id")
  title             String
  content           String
  summary           String
  versionNumber     Int      @map("version_number")
  changeDescription String?  @map("change_description")
  createdAt         DateTime @default(now()) @map("created_at")
  article           Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([articleId, versionNumber])
  @@map("article_versions")
}

model MediaAsset {
  id           String   @id @default(cuid())
  filename     String
  originalName String   @map("original_name")
  mimeType     String   @map("mime_type")
  size         Int
  path         String
  assetType    String   @map("asset_type")
  tags         String   @default("")
  altText      String?  @map("alt_text")
  caption      String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  articleId    String?  @map("article_id")
  article      Article? @relation(fields: [articleId], references: [id])

  @@map("media_assets")
}

model AuditLog {
  id          String   @id @default(cuid())
  action      String
  description String?
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  timestamp   DateTime @default(now())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  category    String   @default("general")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_config")
}

model ExtractionHistory {
  id                 String    @id @default(cuid())
  source             String
  status             String
  parameters         String    @default("{}")
  documentsFound     Int       @default(0) @map("documents_found")
  documentsProcessed Int       @default(0) @map("documents_processed")
  executionTime      Float     @default(0.0) @map("execution_time")
  results            String    @default("{}")
  error              String?
  startedAt          DateTime  @default(now()) @map("started_at")
  completedAt        DateTime? @map("completed_at")
  userId             String?   @map("user_id")
  user               User?     @relation(fields: [userId], references: [id])

  @@map("extraction_history")
}

model GeneratedImage {
  id              String    @id @default(cuid())
  documentId      String?   @map("document_id")
  articleId       String?   @map("article_id")
  imageId         String    @map("image_id") // ID único de la imagen generada
  originalUrl     String    @map("original_url")
  localPath       String    @map("local_path")
  filename        String
  size            Int       // Tamaño del archivo en bytes
  width           Int
  height          Int
  format          String
  model           String    // dalle, gemini
  style           String    // persona, paisaje, elemento
  prompt          String
  metaDescription String?   @map("meta_description") // Metadescripción ≤125 caracteres para SEO
  tags            String    @default("[]") // JSON array de etiquetas temáticas
  savedToLibrary  Boolean   @default(false) @map("saved_to_library") // Guardada en biblioteca
  isPublic        Boolean   @default(false) @map("is_public") // Compartible entre documentos
  usageCount      Int       @default(0) @map("usage_count") // Veces que se ha reutilizado
  lastUsedAt      DateTime? @map("last_used_at") // Última vez que se usó
  createdAt       DateTime  @default(now()) @map("created_at")
  document        Document? @relation(fields: [documentId], references: [id], onDelete: Cascade)
  article         Article?  @relation(fields: [articleId], references: [id], onDelete: SetNull)

  @@unique([imageId])
  @@map("generated_images")
}
